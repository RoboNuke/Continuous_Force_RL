# Real Robot Evaluation Configuration
# Training-specific parameters (gains, action bounds, EMA factor, obs_order) are loaded
# automatically from WandB training config - do NOT duplicate them here.

robot:
  ip: "192.168.1.11"
  use_mock: false              # Set false for real robot
  control_rate_hz: 15.0       # Must match training policy_hz
  reset_duration_sec: 3.0     # Duration for Cartesian reset motion
  retract_height_m: 0.03      # Retract upward before reset to clear hole (meters)
  gripper_force_n: 50.0       # Grasp force in Newtons (max 70N continuous limit)

  # NE_T_EE: -45deg Z rotation + 103.4mm Z offset (flange -> fingertip midpoint)
  # Uses R_z(-45°) to match sim's panda_hand body frame (URDF rpy="0 0 -0.7854").
  # NOTE: Franka standard Hand NE_T_EE uses R_z(+45°); we use -45° so that
  # O_T_EE orientation matches the sim body frame exactly, avoiding any
  # extra rotation in the F/T or observation pipeline.
  # Column-major 4x4 homogeneous transform [R|t; 0 0 0 1]
  NE_T_EE: [
    0.7071, -0.7071, 0.0, 0.0,
    0.7071,  0.7071, 0.0, 0.0,
    0.0,     0.0,    1.0, 0.0,
    0.0,     0.0,    0.1034, 1.0
  ]

  # Stiffness frame = EE frame (identity) - forces measured at fingertip
  EE_T_K: [
    1.0, 0.0, 0.0, 0.0,
    0.0, 1.0, 0.0, 0.0,
    0.0, 0.0, 1.0, 0.0,
    0.0, 0.0, 0.0, 1.0
  ]

  # F/T EMA low-pass filter coefficient (applied at 1kHz inside read_state)
  # alpha=0.2 at 1kHz ~ 32Hz cutoff frequency (-3dB)
  ft_ema_alpha: 0.2

  # Constant F/T bias subtracted from O_F_ext_hat_K BEFORE negation/rotation.
  # Measured in free space with check_ft_bias.py — compensates for unmodeled
  # EE payload (peg + gripper fingers) that the robot's gravity model misses.
  # Set to [0,0,0,0,0,0] to disable.
  ft_bias: [-2.9115, 0.0534, -1.0835, 0.0689, -0.6516, -0.0874]

task:
  # Fixed asset origin position (hole base in world frame, meters)
  # The observation frame (sim's fixed_pos_obs_frame) is computed as:
  #   obs_frame = fixed_asset_position + [0, 0, hole_height + fixed_asset_base_height]
  # which gives the HOLE TIP (entrance) position matching the sim exactly.
  fixed_asset_position: [0.6218, -0.0142, 0.0535] #=0.6225m, y=-0.0084m, z=0.0939m
  fixed_asset_orientation_quat: [1.0, 0.0, 0.0, 0.0]  # [w, x, y, z]
  fixed_asset_yaw: 0.0                # Yaw of fixed asset in world frame (radians)
  fixed_asset_base_height: 0.0        # Height of base plate below hole channel (meters)

  # Target peg base position (where peg base should be when fully inserted)
  # This is "target_held_base_pos" in sim - used for SUCCESS/ENGAGEMENT DETECTION
  # May differ from fixed_asset_position depending on geometry
  target_peg_base_position: [0.6218, -0.0142, 0.0535]

  # Offset from EE (fingertip midpoint) to peg base (grasped object root)
  # Needed to compute peg_base_pos = ee_pos + this offset for detection
  # Must be measured for your specific peg + gripper setup
  ee_to_peg_base_offset: [0.0, 0.0, -0.0412]  # Example: peg extends 50mm below EE

  # Detection thresholds (matching IsaacLab factory env logic exactly)
  # Success: xy_dist < xy_centering_threshold AND z_disp < hole_height * success_threshold
  # Engagement: xy_dist < xy_centering_threshold AND z_disp < hole_height * engage_threshold
  xy_centering_threshold: 0.0025   # 2.5mm - HARDCODED in IsaacLab _get_curr_successes()
  hole_height: 0.025               # 25mm - asset-specific, used to scale Z thresholds
  success_threshold: 0.04          # Multiplied by hole_height -> 1mm Z threshold
  engage_threshold: 0.9            # Multiplied by hole_height -> 22.5mm Z threshold

  # Break detection (matches FragileObjectWrapper)
  break_force_threshold: 10.0      # N - L2 norm of force (Fx,Fy,Fz) >= this triggers break

  # Episode parameters
  episode_timeout_steps: 150       # Max steps per episode
  terminate_on_success: true       # True for real robot (no point continuing), False in sim

control_gains:
  # When true, use gain values below instead of WandB training config.
  # When false, load gains from WandB training config (matching sim exactly).
  use_rr_gains: True

  # Pose PD gains [6]: [Fx, Fy, Fz, Tx, Ty, Tz]
  # task_prop_gains = stiffness (N/m or Nm/rad)
  # task_deriv_gains = damping (Ns/m or Nms/rad), default is 2*sqrt(kp) for critical damping
  #task_prop_gains: [100.0, 100.0, 100.0, 30.0, 30.0, 30.0]
  #task_deriv_gains: [20.0, 20.0, 20.0, 10.954451560974121, 10.954451560974121, 10.954451560974121]

  task_prop_gains: [315.0, 315.0, 315.0, 120.0, 120.0, 0.0]
  task_deriv_gains: [22,22,22, 22, 22, 0]

  #task_prop_gains: [400.0, 400.0, 400.0, 120.0, 120.0, 0.0]
  #task_deriv_gains: [30, 30, 30, 22, 22, 0.0] #15.491933385]



  # Null-space gains (keep joints near default_dof_pos)
  kp_null: 0 #10 #5
  kd_null: 0 #6.32455532 #4.472135955

  # Force gains [6] (hybrid only, ignored for pose-only control)
  # Zeroing based on ctrl_mode is applied automatically after loading.
  force_kp: [1.0, 1.0, 1.0, 1.0, 1.0, 1.0]
  force_kd: [0.1, 0.1, 0.1, 0.1, 0.1, 0.1]
  force_ki: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0]

  # Singularity damping for J M^-1 J^T inverse (Levenberg-Marquardt)
  # Adds lambda*I to prevent blow-up near kinematic singularities.
  # Set enabled=false to revert to undamped inverse.
  singularity_damping_enabled: false
  singularity_damping_lambda: 0.05

noise:
  # When true, use noise values defined below instead of WandB training config.
  # When false, load noise from WandB training config (matching sim exactly).
  use_rr_noise: false

  # Goal observation noise (Gaussian, sampled once per episode)
  goal_pos_noise: [0.00, 0.00, 0.00]   # meters, std per axis
  goal_yaw_noise: 0.0524                    # radians, std (~3 degrees)
  use_yaw_noise: false

  # Start pose (offset from fixed_asset_position)
  hand_init_pos: [0.0, 0.0, 0.047]         # meters, nominal EE offset above hole
  hand_init_pos_noise: [0.00, 0.00, 0.00]  # meters, uniform +/- range per axis
  hand_init_orn: [3.1416, 0.0, 0.0]        # RPY radians, nominal orientation (pointing down)
  hand_init_orn_noise: [0.0, 0.0, 0.0]   # RPY radians, uniform +/- range (~45 deg yaw)
