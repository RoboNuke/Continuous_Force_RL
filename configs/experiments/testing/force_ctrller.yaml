# Force Controller Tuning Configuration
# For use with test_hybrid_controller.py script

# Base configuration to inherit from
base_config: "configs/base/PiH_base.yaml"

primary:
  seed: 42  # Fixed seed for reproducibility
  num_envs_per_agent: 1  # Single environment for tuning
  agents_per_break_force: 1
  break_forces: [10000]  # Unbreakable peg for tuning
  ctrl_mode: "force_only"  # 3DOF force control only

# Enable hybrid control wrapper
wrappers:
  hybrid_control:
    enabled: true
    reward_type: "none"  # No reward needed for manual control
    use_ground_truth_selection: false  # We control selection manually
    

  manual_control:
    enabled: false

  factory_metrics:
    enabled: true
    publish_to_wandb: false

  dynamics_randomization:
    enabled: false

  wandb_logging:
    enabled: false

  pose_contact_logging:
    enabled: false

environment:
  scene:
    num_envs: 1

  sim:
    physx:
      solver_type: 1
      max_position_iteration_count: &pos_iter 32  # Important to avoid interpenetration.
      max_velocity_iteration_count: &vel_iter 8
      bounce_threshold_velocity: 0.2
      friction_offset_threshold: 0.01
      friction_correlation_distance: 0.00625
      #gpu_max_rigid_contact_count: 2**23
      #gpu_max_rigid_patch_count: 2**23
      gpu_max_num_partitions: 1
  
  robot:
    spawn:
      rigid_props:
        solver_position_iteration_count: &robot_pos_iter 32
        solver_velocity_iteration_count: &robot_vel_iter 8
        linear_damping: &lin_damp 0.0

      articulation_props:
        solver_position_iteration_count: *robot_pos_iter
        solver_velocity_iteration_count: *robot_vel_iter

  task:
    #asset_variant: "arch_short_small"
    asset_manifest_path: "assets/peg_hole/manifest.json"
    fixed_asset:
      spawn:
        rigid_props:
          solver_position_iteration_count: *pos_iter
          solver_velocity_iteration_count: *vel_iter
          linear_damping: *lin_damp
    
    held_asset:
      spawn:
        rigid_props:
          solver_position_iteration_count: *pos_iter
          solver_velocity_iteration_count: *vel_iter
          linear_damping: *lin_damp

    
  ctrl:
    async_z_force_bounds: true
    enable_force_derivative: false  # Enable D term (velocity damping) in force control

    force_deriv_scale: 0.25
    force_action_bounds: [20.0, 20.0, 20.0]
    torque_action_bounds: [0.5, 0.5, 0.5]
    force_action_threshold: [10.0, 10.0, 10.0]
    torque_action_threshold: [0.1, 0.1, 0.1]
    default_task_prop_gains: [565.0, 565.0, 565.0, 28.0, 28.0, 28.0]
    
    #default_task_prop_gains: [6000, 6000, 6000, 30, 30, 30]
    default_task_force_gains: [0.75, 0.75, 0.75, 0.001, 0.001, 0.001]
    #default_task_force_gains: [0.5, 0.5, 0.5, 0.001, 0.001, 0.001]
    #default_task_force_gains: [0.15, 0.15, 0.15, 0.001, 0.001, 0.001]
    #default_task_prop_gains: [250, 250, 250, 30, 30, 30]
    ema_factor: 1.0  # 1.0 = no smoothing, use raw actions directly
    use_delta_force: false

    enable_force_integral: true    # Enable I term in force control
    default_task_force_integ_gains: [0.1, 0.1, 0.1, 0.001, 0.001, 0.001]  # Ki gains
    force_integral_clamp: 50.0      # Anti-windup clamp for integral term

  # No observation noise for tuning
  obs_rand:
    fixed_asset_pos: [0.0, 0.0, 0.0]
    ee_pos: [0.0, 0.0, 0.0]
    force_torque: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0]

experiment:
  name: "force_controller_tuning"
  tags: ["tuning", "hybrid_control"]
  group: "ctrl_tuning"
